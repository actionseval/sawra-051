name: YOLOv3 CI
# on: push
on: [repository_dispatch, workflow_dispatch]
jobs:
  Tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
        python-version:
          - '3.11'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Dependencies
        run: |
          apt install -y adduser base-files bash bash-completion binutils-common:amd64 ca-certificates command-not-found coreutils cron-daemon-common curl debconf dhcpcd-base e2fsprogs fontconfig-config fonts-dejavu-core fonts-dejavu-extra fonts-dejavu-mono fonts-lato fonts-liberation fonts-noto-color-emoji fuse3 git hdparm keyutils libattr1:amd64 libaudit-common libbrotli1:amd64 libbsd0:amd64 libc-bin libc6:amd64 libcom-err2:amd64 libcurl3t64-gnutls:amd64 libfontconfig1:amd64 libfreetype6:amd64 libfribidi0:amd64 libgl1:amd64 libglib2.0-0t64:amd64 libglvnd0:amd64 libglx0:amd64 libgmp10:amd64 libgnutls30t64:amd64 libgssapi-krb5-2:amd64 libhogweed6t64:amd64 libidn2-0:amd64 libk5crypto3:amd64 libkeyutils1:amd64 libkrb5-3:amd64 libkrb5support0:amd64 libldap2:amd64 libmagic1t64:amd64 libmd0:amd64 libmecab2:amd64 libnettle8t64:amd64 libnghttp2-14:amd64 libp11-kit0:amd64 libpam-runtime libpcre2-8-0:amd64 libpng16-16t64:amd64 libpsl5t64:amd64 libpython3.11-minimal:amd64 libpython3.11-stdlib:amd64 librtmp1:amd64 libsasl2-2:amd64 libsensors-config libssh-4:amd64 libtasn1-6:amd64 libtirpc-common libunistring5:amd64 libx11-6:amd64 libxau6:amd64 libxcb1:amd64 libxdmcp6:amd64 libzstd1:amd64 locales login logrotate lsb-release ltrace man-db media-types multipath-tools nano netbase nftables openssl overlayroot procps python3.11-minimal rsyslog screen sudo tar tzdata ucf usb-modeswitch util-linux walinuxagent wget
          pip install cycler==0.12.1 kiwisolver==1.4.9 packaging==26.0 pyparsing==3.3.2
      - name: Execute Tests
        run: |
          python -m pip install --upgrade pip wheel
          torch=""
          if [ "1.8.0" == "1.8.0" ]; then
              torch="torch>=1.8.0 torchvision>=0.9.0"
          fi
          pip install -r requirements.txt $torch --extra-index-url https://download.pytorch.org/whl/cpu
          yolo checks
          pip list
          m=yolov5n  # official weights
          b=runs/train/exp/weights/best  # best.pt checkpoint
          python train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu  # train
          for d in cpu; do  # devices
              for w in $m $b; do  # weights
                  python val.py --imgsz 64 --batch 32 --weights $w.pt --device $d  # val
                  python detect.py --imgsz 64 --weights $w.pt --device $d  # detect
              done
          done
          python hubconf.py --model $m  # hub
          python models/yolo.py --cfg $m.yaml  # build PyTorch model
          python export.py --weights $m.pt --img 64 --include torchscript  # export
          python - <<EOF
          import torch
          im = torch.zeros([1, 3, 64, 64])
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
              print(model('data/images/bus.jpg'))
              model(im)  # warmup, build grids for trace
              torch.jit.trace(model, [im])
          EOF
          m=yolov5n-seg  # official weights
          b=runs/train-seg/exp/weights/best  # best.pt checkpoint
          python segment/train.py --imgsz 64 --batch 32 --weights $m.pt --cfg $m.yaml --epochs 1 --device cpu  # train
          python segment/train.py --imgsz 64 --batch 32 --weights '' --cfg $m.yaml --epochs 1 --device cpu  # train
          for d in cpu; do  # devices
              for w in $m $b; do  # weights
                  python segment/val.py --imgsz 64 --batch 32 --weights $w.pt --device $d  # val
                  python segment/predict.py --imgsz 64 --weights $w.pt --device $d  # predict
                  python export.py --weights $w.pt --img 64 --include torchscript --device $d  # export
              done
          done
          m=yolov5n-cls.pt  # official weights
          b=runs/train-cls/exp/weights/best.pt  # best.pt checkpoint
          python classify/train.py --imgsz 32 --model $m --data mnist160 --epochs 1  # train
          python classify/val.py --imgsz 32 --weights $b --data ../datasets/mnist160  # val
          python classify/predict.py --imgsz 32 --weights $b --source ../datasets/mnist160/test/7/60.png  # predict
          python classify/predict.py --imgsz 32 --weights $m --source data/images/bus.jpg  # predict
          python export.py --weights $b --img 64 --include torchscript  # export
          python - <<EOF
          import torch
          for path in '$m', '$b':
              model = torch.hub.load('.', 'custom', path=path, source='local')
          EOF
